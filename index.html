<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Kinerja Harian AO - Integrasi Google Sheets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 30px; }
    table th, table td { text-align: center; }
    canvas { max-width: 100%; }
    .notification {
      position: fixed; top: 10px; right: 10px; z-index: 9999;
    }
  </style>
</head>
<body>
  <h2 class="mb-4">Dashboard Laporan Kinerja Harian AO</h2>

  <!-- Notifikasi -->
  <div id="notification" class="notification"></div>

  <!-- Form Input -->
  <form id="formLaporan" class="row g-3 mb-4">
    <div class="col-md-3">
      <select id="karyawan" class="form-select" required>
        <option value="">Pilih Karyawan</option>
        <!-- Daftar karyawan tetap sama -->
        <option>YASINTA NOVIANA, S.E</option>
        <option>HERNI INDRAYANI, S.P</option>
        <option>VIKA DAMAYANTI, S.Pd</option>
        <option>ZAHRA LINTANG CAHYANI</option>
        <option>FERA AGUSTIN, S.Pd</option>
        <option>KHOIRUDIN LATIF SURYANTO</option>
        <option>OLVIA NANDA, S.E</option>
        <option>NABILA RENATA</option>
        <option>M. ZAINUL ANWAR</option>
        <option>LISNAWATI, S.E</option>
        <option>MAHMUD RIFA'I</option>
        <option>ANUARRUDIN, S.E</option>
        <option>ANDRE HERLI PRATAMA</option>
        <option>IRMA PUSPITA SARI</option>
        <option>NANDA ASHARI DENDI IRAWAN</option>
        <option>ANDIKA CAHYA</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="kantor" class="form-select" required>
        <option value="">Pilih Kantor</option>
        <option>KANTOR METRO</option>
        <option>KANTOR KEDONDONG</option>
        <option>KANTOR SIDOWARAS</option>
        <option>KANTOR GEDONG TATAAN</option>
        <option>KANTOR DAYA MURNI</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="hari" class="form-select" required>
        <option value="">Pilih Hari</option>
        <option>Senin</option>
        <option>Selasa</option>
        <option>Rabu</option>
        <option>Kamis</option>
        <option>Jumat</option>
        <option>Sabtu</option>
        <option>Minggu</option>
      </select>
    </div>
    <div class="col-md-2">
      <input type="number" id="kunjungan" class="form-control" placeholder="Kunjungan Harian" min="0" required />
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Tambah</button>
    </div>
  </form>

  <!-- Export Buttons -->
  <div class="mb-3">
    <button class="btn btn-success" onclick="exportExcel()">Export Excel</button>
    <button class="btn btn-danger" onclick="exportPDF()">Export PDF</button>
  </div>

  <!-- Tabel Harian -->
  <h5>📋 Laporan Harian</h5>
  <table class="table table-bordered" id="tabelLaporan">
    <thead class="table-light">
      <tr>
        <th>Tanggal</th>
        <th>Hari</th>
        <th>Karyawan</th>
        <th>Kantor</th>
        <th>Kunjungan</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>

  <!-- Rekap -->
  <h5 class="mt-5">📊 Rekap Kunjungan per Karyawan</h5>
  <table class="table table-bordered" id="rekapTable">
    <thead class="table-light">
      <tr>
        <th>Karyawan</th>
        <th>Total Kunjungan</th>
      </tr>
    </thead>
    <tbody id="rekapBody"></tbody>
  </table>

  <!-- Grafik -->
  <h5 class="mt-4">📈 Grafik Kunjungan</h5>
  <canvas id="kunjunganChart" height="100"></canvas>

  <!-- Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const form = document.getElementById("formLaporan");
    const body = document.getElementById("dataBody");
    const rekapBody = document.getElementById("rekapBody");
    const chartCanvas = document.getElementById("kunjunganChart");
    const notification = document.getElementById("notification");
    let chartInstance;
    let laporanData = [];

    // === LOAD DATA ===
    if (localStorage.getItem("laporanData")) {
      laporanData = JSON.parse(localStorage.getItem("laporanData"));
      renderTable();
      renderRekap();
      renderChart();
    }

    // 🔴 GANTI DENGAN URL WEB APP ANDA DARI GOOGLE APPS SCRIPT
    const GOOGLE_SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbysberrGhkDYRldI1ZEefMbLWiJbKzb--mxgTw0yaCGLqTPIdC__GdTOABUZKSp-O83xg/exec"; // ← GANTI INI!

    // === FUNGSI NOTIFIKASI ===
    function showNotification(message, isError = false) {
      notification.className = `notification alert ${isError ? 'alert-danger' : 'alert-success'} fade show`;
      notification.textContent = message;
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // === KIRIM KE GOOGLE SHEETS ===
    async function sendDataToGoogleSheets(item) {
      try {
        const response = await fetch(GOOGLE_SHEETS_WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(item),
        });
        const data = await response.json();
        console.log("Google Sheets response:", data);
        if (!response.ok) throw new Error(data.error || "Gagal kirim ke Google Sheets");
        showNotification("Data berhasil dikirim ke Google Sheets & Drive!");
      } catch (e) {
        console.error("Google Sheets error:", e);
        showNotification("Gagal kirim ke Google Sheets. Data tetap tersimpan lokal.", true);
      }
    }

    // === CEK DUPLIKASI ===
    function isDuplicate(newItem) {
      const today = new Date().toLocaleDateString("id-ID");
      return laporanData.some(item =>
        item.karyawan === newItem.karyawan &&
        item.tanggal === today &&
        item.hari === newItem.hari
      );
    }

    // === SUBMIT FORM ===
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const tanggal = new Date().toLocaleDateString("id-ID");
      const hari = document.getElementById("hari").value;
      const karyawan = document.getElementById("karyawan").value;
      const kantor = document.getElementById("kantor").value;
      const kunjungan = parseInt(document.getElementById("kunjungan").value);

      const newItem = {
        tanggal,
        hari,
        karyawan,
        kantor,
        kunjungan,
        timestamp: new Date().toISOString() // tambahkan timestamp
      };

      if (isDuplicate(newItem)) {
        showNotification("Data untuk karyawan ini hari ini sudah ada!", true);
        return;
      }

      laporanData.push(newItem);
      localStorage.setItem("laporanData", JSON.stringify(laporanData));

      sendDataToGoogleSheets(newItem); // Kirim ke Sheets (dan nanti ke Drive via Apps Script)

      renderTable();
      renderRekap();
      renderChart();
      form.reset();
    });

    // === RENDER TABEL ===
    function renderTable() {
      body.innerHTML = "";
      laporanData.forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.tanggal}</td>
          <td>${item.hari}</td>
          <td>${item.karyawan}</td>
          <td>${item.kantor}</td>
          <td>${item.kunjungan}</td>
        `;
        body.appendChild(row);
      });
    }

    // === RENDER REKAP ===
    function renderRekap() {
      rekapBody.innerHTML = "";
      const rekap = {};
      laporanData.forEach((i) => {
        rekap[i.karyawan] = (rekap[i.karyawan] || 0) + i.kunjungan;
      });
      Object.keys(rekap).forEach((k) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td>${rekap[k]}</td>`;
        rekapBody.appendChild(tr);
      });
    }

    // === RENDER GRAFIK ===
    function renderChart() {
      const rekap = {};
      laporanData.forEach((i) => {
        rekap[i.karyawan] = (rekap[i.karyawan] || 0) + i.kunjungan;
      });
      const labels = Object.keys(rekap);
      const data = Object.values(rekap);
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(chartCanvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Total Kunjungan",
            data,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
          }],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: "Total Kunjungan per Karyawan" },
          },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    // === EXPORT EXCEL ===
    function exportExcel() {
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById("tabelLaporan")), "Harian");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById("rekapTable")), "Rekap");
      XLSX.writeFile(wb, "Laporan_Kinerja_Harian_AO.xlsx");
    }

    // === EXPORT PDF (SELURUH LAPORAN) ===
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Ambil seluruh konten laporan
      const content = document.createElement("div");
      content.appendChild(document.getElementById("tabelLaporan").cloneNode(true));
      content.appendChild(document.getElementById("rekapTable").cloneNode(true));
      content.appendChild(document.getElementById("kunjunganChart").cloneNode(true));

      // Sembunyikan sementara elemen non-laporan
      const originalBody = document.body.innerHTML;
      const tempDiv = document.createElement("div");
      tempDiv.style.padding = "20px";
      tempDiv.appendChild(content);
      document.body.innerHTML = "";
      document.body.appendChild(tempDiv);

      try {
        const canvas = await html2canvas(document.body);
        const imgData = canvas.toDataURL("image/png");
        const imgProps = pdf.getImageProperties(imgData);
        const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

        if (pdfHeight > pageHeight) {
          // Skala agar muat
          const scale = pageHeight / pdfHeight;
          pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pdfHeight * scale);
        } else {
          pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pdfHeight);
        }

        pdf.save("Laporan_Kinerja_Harian_AO.pdf");
      } catch (e) {
        console.error("PDF export error:", e);
        showNotification("Gagal ekspor PDF", true);
      } finally {
        // Kembalikan DOM
        document.body.innerHTML = originalBody;
        // Re-render chart (karena canvas hilang)
        renderChart();
      }
    }
  </script>
</body>
</html>
